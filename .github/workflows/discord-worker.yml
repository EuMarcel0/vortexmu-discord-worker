name: Discord Worker - Captura de Logs (Mu online - Vortex MU)

on:
  schedule:
    # Executa a cada 5 minutos, das 20h √†s 23h59 (hor√°rio UTC-3 = 23h √†s 02h59 UTC)
    - cron: "*/5 23-23 * * *" # 20:00-20:59 BRT
    - cron: "*/5 0-2 * * *" # 21:00-23:59 BRT
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  capture-logs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run Discord Worker
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          TZ: America/Sao_Paulo
        run: |
          CURRENT_HOUR=$(TZ=America/Sao_Paulo date +%H)
          echo "‚è∞ Hora atual em S√£o Paulo: $CURRENT_HOUR:$(TZ=America/Sao_Paulo date +%M)"
          
          # Se for execu√ß√£o manual (workflow_dispatch), sempre executa
          # Se for agendado (schedule), verifica o hor√°rio
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üöÄ Execu√ß√£o MANUAL - Executando independente do hor√°rio..."
            node dist/run-once.js
          elif [ "$CURRENT_HOUR" -ge 20 ] && [ "$CURRENT_HOUR" -le 23 ]; then
            echo "‚úÖ Execu√ß√£o AGENDADA - Dentro do hor√°rio. Executando..."
            node dist/run-once.js
          else
            echo "‚è∞ Execu√ß√£o AGENDADA - Fora do hor√°rio (20h-23h59). Pulando..."
          fi

      - name: Summary
        run: echo "‚úÖ Execu√ß√£o conclu√≠da em $(TZ=America/Sao_Paulo date '+%d/%m/%Y %H:%M:%S')"
